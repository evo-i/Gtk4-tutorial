# Периодические события

Эта глава написана Paul Schulz <paul@mawsonlakes.org>.

## Как создать анимацию?

В этом разделе мы продолжим развивать нашу предыдущую работу. Мы создадим
приложение аналоговых часов. Добавив функцию, которая периодически перерисовывает
GtkDrawingArea, часы смогут непрерывно отображать время.

Приложение использует скомпилированный файл 'ресурсов', поэтому если библиотеки GTK4 и
их зависимости установлены и доступны, приложение будет запускаться из
любого места.

Программа также использует некоторые стандартные математические функции и функции обработки времени.

Механика часов была взята из примера рисования Cairo с использованием gtkmm4, который можно найти
[здесь](https://developer-old.gnome.org/gtkmm-tutorial/stable/sec-drawing-clock-example.html.en).

Полный код приведён в конце.

## Рисование циферблата часов, часовой, минутной и секундной стрелок

Функция `draw_clock()` выполняет всю работу. См. комментарии в файле для
объяснения того, как работает рисование Cairo.

Для подробного справочника о том, что делает каждая из функций Cairo, см.
[справочник cairo_t](https://www.cairographics.org/manual/cairo-cairo-t.html).

@@@include
tfc/tfc.c draw_clock
@@@

Чтобы часы были нарисованы, функция рисования `draw_clock()` должна
быть зарегистрирована в GTK4. Это делается в функции `app_activate()` (в строке 24).

Всякий раз, когда приложению нужно перерисовать GtkDrawingArea, оно теперь будет вызывать `draw_clock()`.

Однако всё ещё есть проблема. Чтобы анимировать часы, нам также нужно
сообщить приложению, что часы нужно перерисовывать каждую секунду. Этот
процесс начинается с регистрации (в следующей строке, строка 15) функции таймаута
с помощью `g_timeout_add()`, которая будет пробуждаться и запускать другую функцию `time_handler`,
каждую секунду (или 1000 мс).

@@@include
tfc/tfc.c app_activate
@@@

Наша функция `time_handler()` очень проста, так как она просто вызывает
`gtk_widget_queue_draw()`, которая планирует перерисовку виджета.

@@@include
tfc/tfc.c time_handler
@@@

.. и это всё, что нужно. Если вы скомпилируете и запустите пример, вы получите
тикающие аналоговые часы.

Если вы заставите это работать, вы можете попробовать изменить некоторый код в
`draw_clock()`, чтобы настроить приложение (например, изменить цвет или размер и
длину стрелок) или даже добавить текст, или создать цифровые часы.

## Полный код

Вы можете найти исходные файлы в каталоге `tfc`. Они могут быть скомпилированы с помощью `./comp tfc`.

`tfc.c`

@@@include
tfc/tfc.c
@@@

`tfc.ui`

@@@include
tfc/tfc.ui
@@@

`tfc.gresource.xml`

@@@include
tfc/tfc.gresource.xml
@@@

`comp`

@@@include
tfc/comp
@@@
