# Перетаскивание

## Что такое перетаскивание?

Перетаскивание также записывается как "Drag-and-Drop", или сокращённо "DND".
DND подобно "копировать и вставить" или "вырезать и вставить".
Если пользователь перетаскивает элемент пользовательского интерфейса, который является виджетом, выбранной частью или чем-то ещё, данные передаются из источника в назначение.

Вы, вероятно, имели опыт перемещения файла с помощью DND.

![DND on the GUI file manager](../image/dnd.png){width=4.6cm height=3cm}

Когда DND начинается, файл `sample_file.txt` передаётся системе.
Когда DND заканчивается, система передаёт `sample_file.txt` в каталог `sample_folder` в файловом менеджере.
Поэтому это похоже на "вырезать и вставить".
Фактическое поведение может отличаться от объяснения здесь, но концепция похожа.

## Пример для DND

Этот учебник предоставляет простой пример в каталоге `src/dnd`.
Он имеет три метки для источника и одну метку для назначения.
Исходные метки имеют метки "red", "green" или "blue".
Если пользователь перетаскивает метку на метку назначения, цвет шрифта будет изменён.

![DND example](../image/dnd_canvas.png){width=13.5cm height=5.2cm}

## UI-файл

Виджеты определены в XML-файле `dnd.ui`.

@@@include
dnd/dnd.ui
@@@

Он преобразуется в файл ресурсов с помощью `glib-compile-resources`.
Компилятор использует XML-файл `dnd.gresource.xml`.

@@@include
dnd/dnd.gresource.xml
@@@

## C-файл dnd.c

C-файл `dnd.c` не является большим файлом.
Количество строк меньше ста.
Объект GtkApplication создаётся в функции `main`.

@@@include
dnd/dnd.c main
@@@

ID приложения определён как:

@@@if gfm
```C
#define APPLICATION_ID "com.github.ToshioCP.dnd"
```
@@@else
```{.C}
#define APPLICATION_ID "com.github.ToshioCP.dnd"
```
@@@end

### Обработчик сигнала startup

Большая часть работы выполняется в обработчике сигнала "startup".

Для реализации DND используются два объекта GtkDragSource и GtkDropTarget.

- Источник перетаскивания: источник перетаскивания (экземпляр GtkDragSource) является контроллером событий.
Он инициирует операцию DND, когда пользователь щёлкает и перетаскивает виджет.
Если данные в форме GdkContentProvider установлены заранее, он передаёт данные системе в начале перетаскивания.
- Цель перетаскивания: цель перетаскивания (GtkDropTarget) также является контроллером событий.
Вы можете получить данные в обработчике сигнала GtkDropTarget::drop.

Приведённый ниже пример использует эти объекты очень простым способом.
Вы можете использовать ряд функций, которые есть у этих двух объектов.
Для получения дополнительной информации см. следующие ссылки.

- [Drag-and-Drop in GTK](https://docs.gtk.org/gtk4/drag-and-drop.html)
- [GtkDragSource](https://docs.gtk.org/gtk4/class.DragSource.html)
- [GtkDropTarget](https://docs.gtk.org/gtk4/class.DropTarget.html)

@@@include
dnd/dnd.c app_startup
@@@

- 15-22: строит виджеты.
Массив `source_labels[]` указывает на исходные метки red, green и blue в ui-файле.
Переменная `canvas` указывает на метку назначения.
- 24-30: устанавливает виджеты источника DND.
Цикл for перебирает массив `src_labels[]`, каждый из которых указывает на исходный виджет, метку red, green или blue.
- 25: создаёт новый экземпляр GtkDragSource.
- 26: создаёт новый экземпляр GdkContentProvider со строкой "red", "green" или "blue.
Это имена виджетов.
Эти строки являются данными для передачи через операцию DND.
- 27: устанавливает содержимое источника перетаскивания на экземпляр GdkContentProvider выше.
- 28: содержимое бесполезно, поэтому оно уничтожается.
- 29: добавляет контроллер событий, который на самом деле является источником перетаскивания, к виджету.
Если операция DND начинается на виджете, соответствующий источник перетаскивания работает, и данные передаются системе.
- 32-34: устанавливает цель перетаскивания DND.
- 32: создаёт новый экземпляр GtkDropTarget.
Первый параметр — это GType данных.
Второй параметр — это константа перечисления GdkDragAction.
Аргументами здесь являются тип строки и константа для копирования.
- 33: подключает сигнал "drop" и обработчик `drop_cb`.
- 34: добавляет контроллер событий, который на самом деле является целью перетаскивания, к виджету.
- 36-43: устанавливает CSS.
- 37: переменная `format` является статической и определена в верхней части программы.
Статические переменные показаны ниже.

@@@if gfm
```C
static GtkCssProvider *provider = NULL;
static const char *format = "label {padding: 20px;} label#red {background: red;} "
  "label#green {background: green;} label#blue {background: blue;} "
  "label#canvas {color: %s; font-weight: bold; font-size: 72pt;}";
```
@@@else
```{.C}
static GtkCssProvider *provider = NULL;
static const char *format = "label {padding: 20px;} label#red {background: red;} "
  "label#green {background: green;} label#blue {background: blue;} "
  "label#canvas {color: %s; font-weight: bold; font-size: 72pt;}";
```
@@@end

### Обработчик сигнала activate

@@@include
dnd/dnd.c app_activate
@@@

Этот обработчик просто показывает окно.

### Обработчик сигнала drop

@@@include
dnd/dnd.c drop_cb
@@@

Обработчик сигнала "drop" имеет пять параметров.

- Экземпляр GtkDropTarget, на котором был испущен сигнал.
- GValue, который содержит данные из источника.
- Аргументы `x` и `y` — это координаты мыши при отпускании.
- Пользовательские данные были установлены при подключении сигнала и обработчика.

Строка из GValue — это "red", "green" или "blue".
Она заменяет "%s" в переменной `format`.
Это означает, что цвет шрифта метки `canvas` изменится на этот цвет.

## Meson.build

Файл `meson.build` управляет процессом сборки.

@@@include
dnd/meson.build
@@@

Вы можете собрать его из командной строки.

```
$ cd src/dnd
$ meson setup _build
$ ninja -C _build
$ _build/dnd
```

Исходные файлы находятся в каталоге `src/dnd` [репозитория](https://github.com/ToshioCP/Gtk4-tutorial).
Загрузите его и посмотрите каталог.
