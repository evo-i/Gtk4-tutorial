# Как собрать учебник по Gtk4

## Краткое руководство

1. Вам понадобится операционная система Linux, Ruby, Rake, Pandoc и система LaTeX.
2. Загрузите этот репозиторий и извлеките его содержимое.
3. Измените текущий каталог на корневой каталог исходных файлов.
4. Запустите `rake html` для создания HTML-файлов. Эти файлы будут созданы в каталоге `docs`.
5. Запустите `rake pdf` для создания PDF-файла. Файл создаётся в каталоге `latex`.

## Предварительные требования

- Операционная система Linux:
Программы в этом репозитории были протестированы на Ubuntu 21.04.
- Файлы в этом репозитории:
Есть два способа получить файлы:
  1. Использование Git:
Выполните `git clone https://github.com/ToshioCP/Gtk4-tutorial.git` в вашем терминале.
  2. Загрузка Zip:
Нажмите зелёную кнопку `Code` на главной странице репозитория и выберите "Download ZIP".
- Ruby и Rake.
- Pandoc: используется для преобразования Markdown в HTML и/или LaTeX.
- Система Latex: рекомендуется Tex Live 2020 или более поздняя версия для генерации PDF-файла.

## Варианты Markdown и файлы .src.md

### GitHub Flavored Markdown (GFM)

Когда вы посещаете [репозиторий Gtk4_tutorial на GitHub](https://github.com/ToshioCP/Gtk4-tutorial), файл `README.md` отображается на главной странице.
Этот файл написан на Markdown, который обычно использует расширение .md.

Существует несколько диалектов Markdown.
Файл `README.md` использует "GitHub Flavored Markdown" или просто GFM.
Файлы в каталоге `gfm` также написаны на GFM.
Для получения дополнительной информации обратитесь к [спецификации GitHub Flavor Markdown](https://github.github.com/gfm/).

### Markdown Pandoc

Этот учебник также использует другой диалект, известный как "Markdown Pandoc."
Pandoc — это мощный инструмент для преобразования между форматами, такими как Markdown, HTML, LaTeX и Word (.docx).
В этом проекте этот конкретный диалект используется при преобразовании исходных файлов в HTML или LaTeX.

## Файл .src.md и команды @@@

### Файл .src.md

Исходные файлы в этом проекте используют расширение .src.md.
Синтаксис файла .src.md похож на стандартный Markdown, но он включает специальную пользовательскую команду: команду @@@.
Каждый блок команды начинается со строки, начинающейся с @@@, за которой следует имя команды, и заканчивается строкой, содержащей только `@@@`.

Например,

    @@@include
    tfeapplication.c
    @@@

Первая строка называется директивой, которая состоит из "@@@" и "include" (имя команды).

Существует четыре типа команд @@@, которые описаны ниже.

### @@@include

Эта команда начинается с директивы `@@@include`.

    @@@include
    tfeapplication.c
    @@@

Она заменяется содержимым исходного файла, указанного между маркерами `@@@include` и `@@@`.
Приведённый выше пример включает исходный файл C `tfeapplication.c`.

Если после имени файла следуют имена конкретных функций, будут извлечены только эти функции.

    @@@include
    tfeapplication.c main startup
    @@@

Приведённая выше команда будет заменена конкретно функциями `main` и `startup`, найденными в `tfeapplication.c`.

Вы также можете включать исходные файлы из других языков.
Следующий пример показывает, что файл ruby `lib_src2md.rb` вставляется командой.

    @@@include
    lib_src2md.rb
    @@@

Обратите внимание, что извлечение конкретных функций поддерживается только для исходных файлов C.

Вставленный текст автоматически преобразуется в огороженный блок кода.
Огороженные блоки кода начинаются и заканчиваются `~~~`, а содержимое отображается дословно.
Три последовательных тильды называются "кодовым ограждением", потому что они выглядят как забор.

Когда целевой формат — GFM, после открывающего ограждения добавляется "информационная строка" (идентификатор языка).
Следующий пример показывает, что команда @@@ включает исходный файл C `sample.c`.

    $ cat src/sample.c
    int
    main (int argc, char **argv) {
      ... ...
    }
    $cat src/sample.src.md
      ... ...
    @@@include -N
    sample.c
    @@@
      ... ...
    $ ruby src2md.rb src/sample.src.md
    $ cat gfm/sample.md
      ... ...
    ~~~C
    int
    main (int argc, char **argv) {
      ... ...
    }
    ~~~
      ... ...

Информационные строки обычно являются языками, такими как C, ruby, xml и так далее.
Этот идентификатор определяется расширением файла:

- `.c`   => C
- `.rb`  => ruby
- `.xml` => xml

Список поддерживаемых языков определён в методе `lang` в `lib/lib_src2md.rb`.

По умолчанию номера строк вставляются в начале каждой строки.
Чтобы отключить это, используйте опцию -N с командой `@@@include`.

Опции:

- `-n`: вставляет номер строки в верхней части каждой строки (по умолчанию).
- `-N`: номер строки не вставляется.

Ниже показано, что номера строк вставляются в начале каждой строки.

    $cat src/sample.src.md
      ... ...
    @@@include
    sample.c
    @@@
      ... ...
    $ ruby src2md.rb src/sample.src.md
    $ cat gfm/sample.md
      ... ...
    ~~~C
     1 int
     2 main (int argc, char **argv) {
      ... ...
    14 }
    ~~~
      ... ...

Если файл Markdown является промежуточным шагом для вывода в HTML, используется другая информационная строка.
Если команда `@@@include` не имеет опции `-N`, то сгенерированный markdown будет:

    ~~~{.C .numberLines}
    int
    main (int argc, char **argv) {
      ... ...
    }
    ~~~

Информационная строка `.C` указывает язык C.
Класс `.numberLines` является функцией Markdown от Pandoc; он позволяет Pandoc генерировать CSS, который вставляет номера строк в итоговый HTML.
В результате огороженный блок кода в исходном Markdown не содержит жестко закодированных номеров строк, в отличие от GFM.
Если задана опция `-N`, то информационная строка будет только `{.C}`.

Если файл Markdown является промежуточным шагом для файла LaTeX, та же информационная строка следует после начального ограждения.

    ~~~{.C .numberLines}
    int
    main (int argc, char **argv) {
      ... ...
    }
    ~~~

Rake использует Pandoc с опцией --listings для преобразования Markdown в файл LaTeX.
Итоговый файл LaTeX использует пакет listings для отображения исходного кода вместо простого окружения verbatim.
Файл Markdown преобразуется в следующий исходный файл LaTeX.

    \begin{lstlisting}[language=C, numbers=left]
    int
    main (int argc, char **argv) {
      ... ...
    }
    \end{lstlisting}

Пакет listings может раскрашивать или выделять ключевые слова, строки, комментарии и директивы.
Но он на самом деле не анализирует синтаксис языка, поэтому токены выделения ограничены.

Команда @@@include имеет два преимущества:

1. Меньше набора текста.
2. Изменение исходного файла C не требует ручного обновления файла .src.md, что значительно облегчает сопровождение для авторов.

### @@@shell

Эта команда начинается с директивы `@@@shell`.

    @@@shell
    shell command
     ... ...
    @@@

Она заменяется как самой выполненной командой, так и её стандартным выводом.

Например,

    @@@shell
    wc Rakefile
    @@@

Это преобразуется в:

    ~~~
    $ wc Rakefile
    164  475 4971 Rakefile
    ~~~

### @@@if series (Условное ветвление)

Этот блок команд начинается с `@@@if` и может сопровождаться `@@@elif`, `@@@else` или `@@@end`.
Они работают аналогично директивам препроцессора `#if`, `#elif`, `#else` и `#endif` в C.
Например,

    @@@if gfm
    Refer to  [tfetextview API reference](tfetextview_doc.md)
    @@@elif html
    Refer to  [tfetextview API reference](tfetextview_doc.html)
    @@@elif latex
    Refer to tfetextview API reference in appendix.
    @@@end

Директивы `@@@if` и `@@@elif` принимают условия, такие как `gfm`, `html` или `latex`.

- gfm: Если целью является GFM.
- html: Если целью является HTML.
- latex: Если целью является PDF.

Другие типы условий могут стать доступными в будущих версиях.

Код, анализирующий команды серии @@@if, довольно сложный.
Он основан на диаграмме состояний ниже.

![state diagram](../image/state_diagram.png)

### @@@table

Этот тип команды @@@ начинается со строки, которая начинается с `@@@table`.
Эта команда принимает таблицу в стиле GFM или Pandoc в качестве входных данных и форматирует её, чтобы она была более читаемой для человека в исходном файле.
Например, текстовый файл `sample.md` содержит таблицу вот так:

    Price list

    @@@table
    |item|price|
    |:---:|:---:|
    |mouse|$10|
    |PC|$500|
    @@@

Команда преобразует это в:

~~~
Price list

|item |price|
|:---:|:---:|
|mouse| $10 |
| PC  |$500 |
~~~

Эта команда влияет только на визуальное выравнивание таблицы в Markdown; она не изменяет итоговый вывод в HTML или LaTeX.
Обратите внимание, что команда поддерживает только указанный выше тип формата таблиц Markdown.

Скрипт `mktbl.rb` поддерживает эту команду.
Если вы запустите скрипт следующим образом:

~~~
$ ruby mktbl.rb sample.md
~~~

Тогда таблицы в 'sample.md' будут упорядочены.
Скрипт также создаёт резервный файл `sample.md.bak`.

Задача скрипта кажется лёгкой, но программа не такая простая.
Скрипт `mktbl.rb` использует библиотеку `lib/lib_src2md.rb`

Команды @@@ действуют на протяжении всего текста.
Это означает, что вы не можете остановить команды @@@.
Но иногда вы хотите показать команды буквально.
Одно решение — добавить четыре пробела в начале строк.
Тогда команды @@@ не будут действовать, потому что `@@@` должен находиться в начале строки.

## Преобразование

Команды @@@ обрабатываются методом `src2md` в `lib/lib_src2md.rb`.
Этот метод преобразует файлы .src.md в стандартные файлы Markdown.
Кроме того, метод `src2md` выполняет следующие преобразования:

- **Относительные ссылки:** Они обновляются, чтобы отразить изменение базового каталога.
- **Размеры изображений:** Параметры размера изображения (например, {width=...}) удаляются, когда целевой формат — GFM или HTML.
- **HTML-специфичные ссылки:** Для вывода в HTML все относительные ссылки удаляются, за исключением тех, которые указывают на другие файлы `.src.md`.
- **LaTeX-специфичные ссылки:** Для вывода в LaTeX все относительные ссылки удаляются.

Преобразования выполняются в следующем порядке:

1. @@@if
2. @@@table
3. @@@include
4. @@@shell
5. others

Скрипт `src2md.rb` в корневом каталоге просто вызывает метод `src2md`.
Аналогично, `Rakefile` также вызывает этот метод в рамках своих задач.

## Структура каталогов

Каталог `Gtk4-tutorial` содержит семь подкаталогов: `gfm`, `docs`, `latex`, `src`, `image`, `test` и `lib`.
Каталоги `gfm`, `docs` и `latex` служат папками назначения для файлов GFM, HTML и LaTeX соответственно.
Обратите внимание, что эти три каталога назначения могут не существовать в начале преобразования.
Программа преобразования автоматически создаёт каталоги, если они не существуют.

- `src`: Содержит исходные файлы .src.md и исходный код C.
- `image`: Содержит файлы изображений, такие как PNG или JPG.
- `gfm`: Содержит файлы GFM, преобразованные Rake из исходных файлов .src.md.
- `docs`: Содержит файлы HTML, преобразованные Rake (`rake html`) из исходных файлов .src.md.
- `latex`: Содержит файл PDF и промежуточные файлы LaTeX, преобразованные Rake (`rake pdf`) из исходных файлов .src.md.
- `lib`: Содержит файлы библиотек ruby.
- `test`: Содержит тестовые файлы, которые выполняются запуском `rake test` в терминале.

## Организация исходных файлов

### Каталог `src` и корневой каталог

Каталог `src` содержит файлы .src.md и исходные файлы, связанные с C.
Корневой каталог (`Gtk4-tutorial`) содержит `Rakefile`, `src2md.rb` и другие важные файлы.
Сгенерированный `README.md` размещается в этом корневом каталоге.
Он включает заголовок, обзор и оглавление со ссылками на файлы GFM.

`Rakefile` описывает, как преобразовать файлы .src.md в файлы GFM, HTML и/или PDF.
Rake преобразует исходные файлы в соответствии с `Rakefile`.

### Именование файлов в каталоге `src`

Каталог `src` содержит `abstract.src.md`, отдельные файлы разделов и другие документы .src.md.
Rake преобразует `abstract.src.md` в обзор этого руководства, такой как `gfm/README.md`, `docs/index.html` и/или соответствующую часть файла PDF.
Файлы разделов именуются с использованием префикса "sec", за которым следует номер раздела и расширение .src.md (например, `sec1.src.md`, `sec5.src.md` или `sec12.src.md`).
Это файлы, которые соответствуют разделу 1, разделу 5 и разделу 12 соответственно.

### Хранение исходного кода C

Большинство файлов .src.md используют команду `@@@include` для включения исходного кода C.
Эти файлы C организованы в подкаталоги в каталоге `src`.

Все включённые файлы C были протестированы.
Когда вы компилируете исходные файлы, создаются некоторые вспомогательные файлы и целевой файл вроде `a.out`.
Когда вы используете `meson` и `ninja` для компиляции, они создают временный каталог `_build`.
Эти файлы и каталоги игнорируются Git, как указано в файле .gitignore.

## Перенумерация

Иногда вам может потребоваться вставить новый раздел, например, между разделом 4 и разделом 5.
Вы можете временно назвать его "Раздел 4.5", чтобы разместить его между двумя.
Однако, поскольку номера разделов должны быть целыми числами, раздел 4.5 должен быть переименован в раздел 5, и все последующие номера разделов должны быть увеличены на единицу.

Этот процесс перенумерации обрабатывается автоматически методом `renumber` в `lib/lib_renumber.rb`.
Этот метод выполняет две основные задачи:

- Переименование физических файлов.
- Обновление любых внутренних ссылок или упоминаний внутри файлов .src.md в соответствии с новыми номерами разделов.

## Rakefile

`Rakefile` похож на Makefile, но выполняется Rake, инструментом сборки на основе Ruby.
`Rakefile` в этом проекте определяет следующие задачи:

- `md`: Генерирует файлы GFM Markdown (задача по умолчанию).
- `html`: Генерирует файлы HTML.
- `pdf`: Генерирует исходные файлы LaTeX и компилирует их в PDF с использованием lualatex.
- `all`: Генерирует файлы GFM, HTML и PDF.
- `clean`: Удаляет промежуточные файлы LaTeX.
- `clobber`: Удаляет все сгенерированные файлы.

Rake автоматически выполняет процесс перенумерации перед выполнением любой из этих задач.

### Генерация файлов GFM

Вы можете сгенерировать файлы GFM, просто запустив Rake в вашем терминале:

    $ rake

Эта команда генерирует `README.md` из `src/abstract.src.md` и заголовков каждого файла .src.md.
В то же время она преобразует каждый файл .src.md в файл GFM и сохраняет его в каталоге `gfm`.
Навигационные ссылки (например, "Next" и "Previous") автоматически вставляются в верхнюю и нижнюю части каждого сгенерированного файла Markdown.

Вы можете указать ширину и высоту изображений внутри файлов .src.md, используя следующий синтаксис:

    ![sample image](../image/sample_image.png){width=10cm height=6cm}

Поскольку атрибуты размера изображения (например, {width=10cm}) специфичны для LaTeX и не поддерживаются синтаксисом GFM,
они автоматически удаляются во время преобразования в GFM или HTML.

Если файл .src.md имеет относительные URL-ссылки, они будут изменены при преобразовании, поскольку файлы GFM находятся в каталоге `gfm`, а файлы .src.md находятся в каталоге `src`.
Это означает, что базовый каталог относительных ссылок отличается.
Например, `[src/sample.c](sample.c)` переводится в `[src/sample.c](../src/sample.c)`.

Аналогично, если ссылка указывает на другой файл .src.md, целевое расширение автоматически обновляется до .md.
Например, `[Section 5](sec5.src.md)` переводится в `[Section 5](sec5.md)`.

Следующая команда очищает все сгенерированные файлы.

    $ rake clobber

Иногда это необходимо перед генерацией файлов GFM.

    $ rake clobber
    $ rake

Если вы добавляете новый раздел, запуск rake clobber необходим для обеспечения корректного обновления навигационных ссылок "Next" и "Previous".
Без `rake clobber` эти ссылки могут не обновиться, потому что отслеживание зависимостей Rake увидит, что существующие файлы .md в каталоге `gfm` уже новее, чем соответствующие исходные файлы .src.md.
В качестве альтернативы использование команды touch для файла .src.md предыдущего раздела также принудительно обновит его навигационные ссылки.

Если вы просматриваете репозиторий GitHub (ToshioCP/Gtk4-tutorial), `README.md` отображается под кодом.
И `README.md` включает ссылки на каждый файл Markdown.
Это позволяет репозиторию GitHub функционировать не только как хост исходного кода, но и как читаемая онлайн-версия всего руководства.

### Генерация файлов HTML

Файлы .src.md также могут быть преобразованы в HTML.
Этот процесс требует Pandoc.
Большинство дистрибутивов Linux включают пакет Pandoc; обратитесь к документации вашего дистрибутива для инструкций по установке.

Введите `rake html` для генерации файлов HTML.

    $ rake html

Rake сначала генерирует промежуточные файлы Markdown в стиле Pandoc в каталоге `docs`.
Затем он выполняет `pandoc` для преобразования их в итоговые файлы HTML.
Ширина и высота файлов изображений удаляются.
Ссылки на файлы .src.md будут преобразованы следующим образом.

    [Section 5](sec5.src.md) => [Section 5](sec5.html)

Файлы изображений копируются в каталог `docs/image`, и их ссылки соответственно обновляются:

    [sample.png](../image/sample.png) => [sample.png](image/sample.png)

Другие относительные ссылки будут удалены.

Верхний файл HTML `index.html` соответствует файлу `README.md` в каталоге `gfm`.
Если вы хотите очистить файлы HTML, введите `rake clobber` или `cleanhtml`.

    $ rake clobber

Каждый файл HTML включает стандартный заголовок (`<head> ... </head>`), сгенерированный Pandoc с использованием опции standalone (-s).
Вы можете настроить вывод с помощью собственного файла шаблона для pandoc.
Rake использует `lib/lib_mk_html_template.rb` для создания собственного шаблона.
Этот шаблон интегрирует CSS и JavaScript Bootstrap через CDN jsDelivr.

Каталог `docs` содержит все необходимые файлы html.
Они используются на [страницах GitHub](https://ToshioCP.github.io/Gtk4-tutorial) этого репозитория.

Чтобы опубликовать это руководство на вашем собственном веб-сайте, просто загрузите содержимое каталога `docs` на ваш веб-сервер.

### Генерация файла PDF

Преобразование файлов Markdown в исходные файлы LaTeX также требует Pandoc.

Введите `rake pdf` для генерации файлов laTeX и, наконец, создания файла PDF.

    $ rake pdf

Сначала генерируются файлы Markdown от Pandoc в каталоге `latex`.
Затем Pandoc преобразует их в файлы LaTeX.
Ссылки на локальные файлы или каталоги удаляются во время преобразования, потому что LaTeX не поддерживает их таким же образом.
Однако внешние URL и ссылки на изображения сохраняются.
Размеры изображений определяются значениями, указанными в фигурных скобках в исходном файле.

    ![sample image](../image/sample_image.png){width=10cm height=6cm}

Вы должны указать соответствующие размеры; хорошее эмпирическое правило — примерно 0.015 x (ширина в пикселях) см.
Например, если ширина изображения 400 пикселей, ширина в файле LaTeX будет почти 6 см.

Файл `main.tex` служит корневым файлом LaTeX.
Он содержит команды `\input` между тегами `\begin{document}` и `\end{document}` для включения каждого отдельного раздела.
Он также имеет `\input`, который вставляет `helper.tex` в преамбулу.
Как `main.tex`, так и `helper.tex` генерируются скриптом `lib/lib_gen_main_tex.rb`.
Скрипт преобразует образец фрагмента Markdown с использованием `pandoc -s`, извлекает получившуюся преамбулу LaTeX и сохраняет её в `helper.tex`.
Вы можете настроить `helper.tex`, изменив `lib/lib_gen_main_tex.rb`.

Наконец, LuaLaTeX компилирует `main.tex` в файл PDF.

Если вы хотите очистить каталог `latex`, введите `rake clobber` или `rake cleanlatex`

    $ rake clobber

Это удаляет все исходные файлы LaTeX и файл PDF.
